/* eslint-env jest */
const Insight = require('../src').Insight

const explorer = new Insight('https://insight.bitpay.com/api', false)

test('getBlock', (done) => {
  explorer.getBlock('628c568ca24b1b89d38a03fca447541b49479b9427e2ed13a55c872e5cb2fe63').then((block) => {
    expect(block.hash).toBe('628c568ca24b1b89d38a03fca447541b49479b9427e2ed13a55c872e5cb2fe63')
    expect(block.size).toBe(317)
    expect(block.height).toBe(2780228)
    expect(block.version).toBe(536870912)
    done()
  })
})

test('getBlockIndex', (done) => {
  explorer.getBlockIndex(2780228).then((block) => {
    expect(block.blockHash).toBe('628c568ca24b1b89d38a03fca447541b49479b9427e2ed13a55c872e5cb2fe63')
    done()
  })
})

test('getRawBlock', (done) => {
  explorer.getRawBlock('628c568ca24b1b89d38a03fca447541b49479b9427e2ed13a55c872e5cb2fe63').then((block) => {
    expect(block.rawblock).toBe('00000020b2e8bdae0b6f9dc380b06b855bbff323a8481766e3003cba05ab02c37f152e3cb1651707f947b9fba56b72cdb64a8fc18a46bfc9269a02a52bf8644e311d9af2ccc1115b0e380f1b1254a33f0102000000010000000000000000000000000000000000000000000000000000000000000000ffffffff4c03446c2a04b4c1115b08fabe6d6d2039c8336e197f8d6a8c049920f506ed17ab5b273af6cd8263f2efa532be6b37010000000000000077ffffc6030000000d2f6e6f64655374726174756d2f00000000020000000000000000266a24aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf9807c814a000000001976a91485143d1e525f665f0e6ab306e7f61a3a710988bc88ac000000001b68747470733a2f2f7777772e6d696e696e672d64757463682e6e6c')
    done()
  })
})

test('getBlockSummary', (done) => {
  explorer.getBlockSummary(2, '2018-01-01').then((res) => {
    expect(res.blocks).toEqual([
      {
        height: 2523155,
        size: 466,
        virtualSize: 466,
        hash: '07bbde41cd7e1846bca8535a892fe2f74ebf71c0fbc35eb14fad2bba6a30d45e',
        time: 1514850719,
        txlength: 2,
        poolInfo: {}
      },
      {
        height: 2523154,
        size: 241,
        virtualSize: 241,
        hash: '5d4c507ca6dca215b7d1567b822135eee1820b2fe04c3729cf2a4bb0dca21cff',
        time: 1514850654,
        txlength: 1,
        poolInfo: {}
      }
    ])
    done()
  })
})
test('getTransaction', (done) => {
  explorer.getTransaction('79c5ad8517e5f9976ebf98a46fc609bd62abc0fa1ab439600dc2a40ca0f0d25e').then((tx) => {
    expect(tx.txid).toBe('79c5ad8517e5f9976ebf98a46fc609bd62abc0fa1ab439600dc2a40ca0f0d25e')
    expect(tx.version).toBe(1)
    expect(tx.blockhash).toBe('0000000000000000000aa10721c72f1220ce068599b860b06251d827348a2ae4')
    done()
  })
})

test('getRawTransaction', (done) => {
  explorer.getRawTransaction('f29a1d314e64f82ba5029a26c9bf468ac18f4ab6cd726ba5fbb947f9071765b1').then((tx) => {
    expect(tx.rawtx).toBe('02000000010000000000000000000000000000000000000000000000000000000000000000ffffffff4c03446c2a04b4c1115b08fabe6d6d2039c8336e197f8d6a8c049920f506ed17ab5b273af6cd8263f2efa532be6b37010000000000000077ffffc6030000000d2f6e6f64655374726174756d2f00000000020000000000000000266a24aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf9807c814a000000001976a91485143d1e525f665f0e6ab306e7f61a3a710988bc88ac000000001b68747470733a2f2f7777772e6d696e696e672d64757463682e6e6c')
    done()
  })
})

test('getAddress', (done) => {
  explorer.getAddress('1PSuvt641rsJm4RF4swAxMAa4zhNpzqJLt').then((address) => {
    expect(address.addrStr).toBe('1PSuvt641rsJm4RF4swAxMAa4zhNpzqJLt')
    expect(address.txApperances >= 1).toBe(true)
    done()
  })
})

test('getAddressProperties balance', (done) => {
  explorer.getAddressProperties('FBkGd8vUUPzybvDJmm8N22BTafEo7BjVre', 'balance').then((amount) => {
    expect(amount >= 0).toBe(true)
    done()
  })
})

test('getAddressProperties totalReceived', (done) => {
  explorer.getAddressProperties('FBkGd8vUUPzybvDJmm8N22BTafEo7BjVre', 'totalReceived').then((amount) => {
    expect(amount >= 125869953).toBe(true)
    done()
  })
})

test('getAddressProperties totalSent', (done) => {
  explorer.getAddressProperties('FBkGd8vUUPzybvDJmm8N22BTafEo7BjVre', 'totalSent').then((amount) => {
    expect(amount >= 0).toBe(true)
    done()
  })
})

test('getAddressProperties unconfirmedBalance', (done) => {
  explorer.getAddressProperties('FBkGd8vUUPzybvDJmm8N22BTafEo7BjVre', 'unconfirmedBalance').then((amount) => {
    expect(amount >= 0).toBe(true)
    done()
  })
})

test('getAddressUtxo', (done) => {
  explorer.getAddressUtxo('1PSuvt641rsJm4RF4swAxMAa4zhNpzqJLt').then((utxos) => {
    expect(utxos[0].txid).toBe('9a70b37498db44e1e2b2dff453cca3cc8034626d6805dbe113a6e646cad4cac5')
    expect(utxos[0].scriptPubKey).toBe('76a9146dfc95ab490ec5090c1023043d2dc577b9d8be8988a')
    expect(utxos[0].amount).toBe(0.001) // idk
    done()
  })
})

test('getTransactionsForBlock', (done) => {
  explorer.getTransactionsForBlock('628c568ca24b1b89d38a03fca447541b49479b9427e2ed13a55c872e5cb2fe63').then((res) => {
    expect(res.txs[0].txid).toBe('f29a1d314e64f82ba5029a26c9bf468ac18f4ab6cd726ba5fbb947f9071765b1')
    done()
  })
})

test('getTransactionsForAddress', (done) => {
  explorer.getTransactionsForAddress('FFrfhbjbqgVNs6WYatav2wnb7LrCcmyDmm').then((res) => {
    expect(res.txs[0].txid).toBe('96ff94c61ab95312d8ae483f91ff28f49de4e2d2371ff182168ebfbdc5f54faf')
    expect(res.txs[0].floData).toBe('text:Insight Tests')
    done()
  })
})

test('getTransactionsForAddresses', (done) => {
  explorer.getTransactionsForAddresses(['FUKsiTMSwLFqMoyJXPeeKEoPnHzZrndScJ', 'FFrfhbjbqgVNs6WYatav2wnb7LrCcmyDmm']).then((res) => {
    expect(res.items[0].txid).toBe('7687e361f00998f96b29938bf5b7d9003a15ec182c13b6ddbd5adc0f993cbf9c')
    expect(res.items[1].txid).toBe('96ff94c61ab95312d8ae483f91ff28f49de4e2d2371ff182168ebfbdc5f54faf')
    done()
  })
})

test('broadcastRawTransaction', (done) => {
  explorer.broadcastRawTransaction('02000000010000000000000000000000000000000000000000000000000000000000000000ffffffff4c03446c2a04b4c1115b08fabe6d6d2039c8336e197f8d6a8c049920f506ed17ab5b273af6cd8263f2efa532be6b37010000000000000077ffffc6030000000d2f6e6f64655374726174756d2f00000000020000000000000000266a24aa21a9ede2f61c3f71d1defd3fa999dfa36953755c690689799962b48bebd836974e8cf9807c814a000000001976a91485143d1e525f665f0e6ab306e7f61a3a710988bc88ac000000001b68747470733a2f2f7777772e6d696e696e672d64757463682e6e6c').then((res) => {
    expect(res.txid).toBe('f29a1d314e64f82ba5029a26c9bf468ac18f4ab6cd726ba5fbb947f9071765b1')
    done()
  })
})

test('broadcastRawTransaction', (done) => {
  explorer.broadcastRawTransaction('0100000002d8c8df6a6fdd2addaf589a83d860f18b44872d13ee6ec3526b2b470d42a96d4d000000008b483045022100b31557e47191936cb14e013fb421b1860b5e4fd5d2bc5ec1938f4ffb1651dc8902202661c2920771fd29dd91cd4100cefb971269836da4914d970d333861819265ba014104c54f8ea9507f31a05ae325616e3024bd9878cb0a5dff780444002d731577be4e2e69c663ff2da922902a4454841aa1754c1b6292ad7d317150308d8cce0ad7abffffffff2ab3fa4f68a512266134085d3260b94d3b6cfd351450cff021c045a69ba120b2000000008b4830450220230110bc99ef311f1f8bda9d0d968bfe5dfa4af171adbef9ef71678d658823bf022100f956d4fcfa0995a578d84e7e913f9bb1cf5b5be1440bcede07bce9cd5b38115d014104c6ec27cffce0823c3fecb162dbd576c88dd7cda0b7b32b0961188a392b488c94ca174d833ee6a9b71c0996620ae71e799fc7c77901db147fa7d97732e49c8226ffffffff02c0175302000000001976a914a3d89c53bb956f08917b44d113c6b2bcbe0c29b788acc01c3d09000000001976a91408338e1d5e26db3fce21b011795b1c3c8a5a5d0788ac00000000').then((res) => {
    expect(res.txid).toBe('f29a1d314e64f82ba5029a26c9bf468ac18f4ab6cd726ba5fbb947f9071765b1')
    done()
  })
})

test('getSync', (done) => {
  explorer.getSync().then((res) => {
    expect(res.blockChainHeight >= 2780247).toBe(true)
    done()
  })
})

test('getPeer', (done) => {
  explorer.getPeer().then((res) => {
    expect(res.connected).toBe(true)
    done()
  })
})

test('getStatus', (done) => {
  explorer.getStatus('getInfo').then((res) => {
    expect(res.info.blocks >= 2780247).toBe(true)
    done()
  })
})

test('getExchangeRate', (done) => {
  explorer.getExchangeRate().then((res) => {
    expect(res.data).toBeDefined()
    done()
  })
})
